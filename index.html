<!DOCTYPE html>
<html>
<head>
  <title>Mini Trading</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      background:#111;
      color:white;
      font-family:Arial;
      text-align:center;
      padding:40px;
    }

    select, button {
      padding:10px;
      margin:10px;
    }

    #chart {
      width:100%;
      max-width:900px;
      height:500px;
      margin:40px auto;
    }
  </style>
</head>

<body>

<h1>Mini Trading ðŸ“ˆ</h1>

<select id="tickerSelect"></select>
<button onclick="loadData()">Carregar</button>

<div id="chart"></div>

<script>
  const { createClient } = supabase;

  const client = createClient(
    "https://vlqteefeuxhovubojybd.supabase.co",
    "sb_publishable_KmHWU0IJzCkwXBWzWMe1WQ_M-sSaxk0"
  );

  let chart;
  let lineSeries;

  function createChart() {
    const chartContainer = document.getElementById("chart");
    chartContainer.innerHTML = "";

    chart = LightweightCharts.createChart(chartContainer, {
      layout: {
        background: { color: "#111" },
        textColor: "#DDD"
      },
      grid: {
        vertLines: { color: "#222" },
        horzLines: { color: "#222" }
      },
      width: chartContainer.clientWidth,
      height: 500,
    });

    lineSeries = chart.addLineSeries({
      color: "#4CAF50",
      lineWidth: 2
    });
  }

  async function loadTickers() {
    const { data, error } = await client
      .from("prices")
      .select("ticker");

    if (error) return;

    const uniqueTickers = [...new Set(data.map(item => item.ticker))];

    const select = document.getElementById("tickerSelect");
    select.innerHTML = "";

    uniqueTickers.forEach(ticker => {
      const option = document.createElement("option");
      option.value = ticker;
      option.textContent = ticker;
      select.appendChild(option);
    });
  }

  async function loadData() {
    const ticker = document.getElementById("tickerSelect").value;

    const { data, error } = await client
      .from("prices")
      .select("*")
      .eq("ticker", ticker)
      .order("date", { ascending: true });

    if (error) return;

    const chartData = data.map(item => ({
      time: item.date,
      value: parseFloat(item.price)
    }));

    createChart();
    lineSeries.setData(chartData);
  }

  loadTickers();
  createChart();
</script>

</body>
</html>
